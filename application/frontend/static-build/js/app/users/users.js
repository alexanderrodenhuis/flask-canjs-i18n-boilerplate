define(["can","app/models/user/user","app/models/user/filter_user_current","app/models/user/connection_facebook","app/models/user/follower","app/models/user/following","app/share/tab","app/components/navbar","utils","i18n","jquery","jquery.bootstrap"],function(e,t,o,n,a,i,r,s,l,d,f){var c,u,w,h,p=e.Control.extend({init:function(){l.logInfo("*User/Read","Initialized")},load:function(e){t.findOne({id:e},function(t){u.user=t,a.findAll({id:e},function(t){u.followers_data=t,i.findAll({id:e},function(e){u.following_data=e,u.show(),l.refreshTitle()})})})},show:function(){l.logJson("*User/Read.show data",this.user),this.following=this.following_data.following,this.followers=this.followers_data.followers,this.following_flag={has_next:this.following_data.has_next,current_page:this.following_data.current_page},this.followers_flag={has_next:this.followers_data.has_next,current_page:this.followers_data.current_page},this.element.html(e.view("/static/views/user/profile.mustache",{user_data:this.user,following_flag:this.following_flag,following:this.following,followers_flag:this.followers_flag,followers:this.followers}))},".perform-follow click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.performFollow(),!1},".perform-unfollow click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.performUnfollow(),!1},".show-more-following click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.showMoreFollowing(),!1},".show-more-followers click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.showMoreFollowers(),!1},performFollow:function(){var t=this.element.find("#followersForm"),o=e.deparam(t.serialize()),n=f(t);if(!n.data("submitted")){n.data("submitted",!0);var i=this.element.find(".perform-unfollow");i.attr("disabled","disabled"),e.when(a.create(o)).then(function(e){i.removeAttr("disabled"),n.data("submitted",!1),l.showSuccessMsg(d.t("profile.follow.success",e.email)),u.load(o.id)},function(e){l.handleStatusWithErrorMsg(e,d.t("profile.follow.failed"))})}},performUnfollow:function(){var t=this.element.find("#followersForm"),o=e.deparam(t.serialize()),n=f(t);if(!n.data("submitted")){n.data("submitted",!0);var i=this.element.find(".perform-follow");i.attr("disabled","disabled"),e.when(a.destroy(o.id)).then(function(e){i.removeAttr("disabled"),n.data("submitted",!1),l.showSuccessMsg(d.t("profile.unfollow.success",e.email)),u.load(o.id)},function(e){l.handleStatusWithErrorMsg(e,d.t("profile.unfollow.failed"))})}},showMoreFollowing:function(){var e=this.element.find(".show-more-following");e.attr("disabled","disabled"),i.findAll({id:u.user.user.id,current_page:u.following_data.current_page+1},function(t){t.has_next?e.removeAttr("disabled"):e.addClass("hidden"),u.following_data.attr("current_page",t.current_page),u.following_data.attr("has_next",t.has_next),u.following.attr(u.following.attr().concat(t.following.attr()))})},showMoreFollowers:function(){var e=this.element.find(".show-more-followers");e.attr("disabled","disabled"),a.findAll({id:u.user.user.id,current_page:u.followers_data.current_page+1},function(t){t.has_next?e.removeAttr("disabled"):e.addClass("hidden"),u.followers_data.attr("current_page",t.current_page),u.followers_data.attr("has_next",t.has_next),u.followers.attr(u.followers.attr().concat(t.followers.attr()))})}}),m=e.Control.extend({init:function(){l.logInfo("*User/Update","Initialized")},load:function(e){o.findOne({},function(t){w.data=t,n.findAll({},function(t){w.has_facebook_connection=t.has_facebook_connection,w.show(),w.selectTab(e),l.refreshTitle()})})},show:function(){this.element.html(e.view("/static/views/user/setting.mustache",{data:this.data,has_facebook_connection:this.has_facebook_connection}))},selectTab:function(e){switch(e||(e="basic"),c.activeTab(e),e){case"basic":case"change-password":case"connection":case"leave-our-service":c.showTab(e);break;default:c.showTab("basic")}},".update-user-password click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.performUpdatePassword(),!1},".send-to-facebook click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.performSendToFacebook(),!1},".disconnect-to-facebook click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.performDisconnectToFacebook(),!1},validate:function(){return l.minLength("currentPassword",8,"validation.password")&&l.minLength("newPassword",8,"validation.password")&&l.minLength("newPasswordConfirm",8,"validation.password")&&l.maxLength("currentPassword",20,"validation.password")&&l.maxLength("newPassword",20,"validation.password")&&l.maxLength("newPasswordConfirm",20,"validation.password")&&l.isIdentical("newPassword","newPasswordConfirm","validation.newPasswordConfirm")},validateSendtoFB:function(){return l.minLengthTextarea("content",3,"validation.contentTooShort")},performUpdatePassword:function(){if(this.validate()){var o=this.element.find("#updatePasswordForm"),n=e.deparam(o.serialize()),a=f(o);if(!a.data("submitted")){a.data("submitted",!0);var i=this.element.find(".update-user-password");i.attr("disabled","disabled"),t.findOne({id:n.id},function(e){e.attr(n),e.save(function(e){return i.removeAttr("disabled"),a.data("submitted",!1),e.password_incorrect?(l.showErrorMsg(d.t("setting.changePassword.passwordIncorrect")),!1):(l.showSuccessMsg(d.t("setting.changePassword.success")),void 0)},function(e){i.removeAttr("disabled"),a.data("submitted",!1),l.handleStatusWithErrorMsg(e,d.t("setting.changePassword.failed"))})})}}else l.showMessages()},performDisconnectToFacebook:function(){n.destroy(function(){w.load("connection"),window.location.reload(!0)})},performSendToFacebook:function(){if(this.validateSendtoFB()){var t=this.element.find("#sendToFacebookForm"),o=e.deparam(t.serialize()),a=f(t);if(!a.data("submitted")){a.data("submitted",!0);var i=this.element.find(".send-to-facebook");i.attr("disabled","disabled"),e.when(n.create(o)).then(function(e){i.removeAttr("disabled"),a.data("submitted",!1),e.status?(l.showSuccessMsg(d.t("facebook.send.success")),f("#content").val("")):l.showErrorMsg(d.t("facebook.send.failed"))},function(){w.performDisconnectToFacebook(),l.showErrorMsg(d.t("facebook.send.connectionFailed"))})}}else l.showMessages()}}),g=e.Control.extend({init:function(){this.isConfirmed=!1,l.logInfo("*User/Destroy","Initialized")},".leave-our-service-confirm click":function(e,t){return l.logInfo("*User/Destroy","Confirm Clicked in users"),t.preventDefault(),t.stopPropagation(),this.performConfirm(),!1},".leave-our-service-final click":function(t,o){return o.preventDefault(),o.stopPropagation(),this.isConfirmed=!0,e.when(f("#leaveOurServiceConfirm").modal("hide")).then(this.performDestroy()),!1},".cancel-confirm click":function(e,t){return t.preventDefault(),t.stopPropagation(),this.isConfirmed=!1,this.performCancel(),!1},performCancel:function(){},performConfirm:function(){f("#leaveOurServiceConfirm").modal()},performDestroy:function(){var o=this.element.find("#leaveOurServiceForm"),n=e.deparam(o.serialize()),a=f(o);if(!a.data("submitted")){a.data("submitted",!0);var i=this.element.find(".leave-our-service-final");i.attr("disabled","disabled"),e.when(t.destroy(n.id)).then(function(){l.showSuccessMsg(d.t("setting.leaveOurService.success")),s.load(),l.replaceHash("")},function(){i.removeAttr("disabled"),a.data("submitted",!1),l.showErrorMsg(d.t("setting.leaveOurService.failed"))})}}}),b=e.Control.extend({defaults:{}},{init:function(){l.logInfo("*Users/Router","Initialized")},"profile route":function(){o.findOne({},function(t){e.route.attr("id",t.user.id)})},"profile/:id route":function(e){u=new p(l.getFreshApp()),u.load(e.id)},"setting route":function(){e.route.attr("tab","basic")},"setting/:tab route":function(e){var t=l.getFreshApp();w=new m(t),c=new r(t,{route:"setting"}),h=new g(t),w.load(e.tab)}});return b});
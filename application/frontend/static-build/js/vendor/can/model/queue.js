define(["can/util/library","can/model","can/observe/backup"],function(t){var e=function(e,n){var r,i,o=t.extend(!0,{},n);if(e)for(var s=0;s<e.length;s++){for(r=o,i=e[s].split(".");i.length>1;)r=r&&r[i.shift()];r&&delete r[i.shift()]}return o},n=function(e,n,r,i){this._changedAttrs=this._changedAttrs||[];var o,s,a=new t.Deferred,u=this,l=this.attr(),c=this._requestQueue,f=this._changedAttrs;return o=function(t,e,n,r){return function(){return t.constructor._makeRequest([t,l],e||(t.isNew()?"create":"update"),n,r,i)}}(this,r,function(){a.resolveWith(u,arguments),c.splice(0,1),c.length>0?c[0]=c[0]():f.splice(0)},function(){a.rejectWith(u,arguments),c.splice(0),f.splice(0)}),s=c.push(o)-1,1===c.length&&(c[0]=c[0]()),a.abort=function(){var t;return t=c[s].abort&&c[s].abort(),c.splice(s),0===c.length&&f.splice(0),t},a.then(e,n),a},r=t.Model.prototype._changes,i=t.Model.prototype.destroy,o=t.Model.prototype.setup;return t.each(["created","updated","destroyed"],function(n){var r=t.Model.prototype[n];t.Model.prototype[n]=function(t){t&&"object"==typeof t&&(t=t.attr?t.attr():t,this._backupStore=t,t=e(this._changedAttrs||[],t)),r.call(this,t)}}),t.extend(t.Model.prototype,{setup:function(){o.apply(this,arguments),this._requestQueue=new t.Observe.List},_changes:function(t,e){this._changedAttrs&&this._changedAttrs.push(e),r.apply(this,arguments)},hasQueuedRequests:function(){return this._requestQueue.attr("length")>1},save:function(){return n.apply(this,arguments)},destroy:function(t,e){return this.isNew()?i.call(this,t,e):n.call(this,t,e,"destroy","destroyed")}}),t});
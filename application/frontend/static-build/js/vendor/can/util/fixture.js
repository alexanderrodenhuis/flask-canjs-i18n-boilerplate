define(["can/util/library","can/util/string","can/util/object"],function(t){var e=function(e){return"undefined"!=typeof steal?t.isFunction(steal.config)?steal.config().root.mapJoin(e).toString():steal.root.join(e).toString():(t.fixture.rootUrl||"")+e},n=function(n,r){if(t.fixture.on){var i=function(){"undefined"!=typeof steal&&steal.dev&&steal.dev.log("fixture INFO: "+Array.prototype.slice.call(arguments).join(" "))};n.type=n.type||n.method||"GET";var o=u(n);if(!n.fixture)return"file:"===window.location.protocol&&i("ajax request to "+n.url+", no fixture found"),void 0;if("string"==typeof n.fixture&&t.fixture[n.fixture]&&(n.fixture=t.fixture[n.fixture]),"string"==typeof n.fixture){var s=n.fixture;/^\/\//.test(s)&&(s=e(n.fixture.substr(2))),o&&(s=t.sub(s,o)),delete n.fixture,n.url=s,n.data=null,n.type="GET",n.error||(n.error=function(t,e,n){throw"fixtures.js Error "+e+" "+n})}else n.dataTypes&&n.dataTypes.splice(0,0,"fixture"),o&&r&&t.extend(r.data,o)}},r=function(t,e,n,r){return"number"!=typeof t&&(r=e,n=t,e="success",t=200),"string"!=typeof e&&(r=n,n=e,e="success"),t>=400&&599>=t&&(this.dataType="text"),[t,e,i(this,n),r]},i=function(t,e){var n=t.dataTypes?t.dataTypes[0]:t.dataType||"json";if(!e||!e[n]){var r={};r[n]=e,e=r}return e};if(t.ajaxPrefilter&&t.ajaxTransport)t.ajaxPrefilter(n),t.ajaxTransport("fixture",function(e,n){e.dataTypes.shift();var o,s=!1;return{send:function(a,u){o=setTimeout(function(){var t=function(){s===!1&&u.apply(null,r.apply(e,arguments))},o=e.fixture(n,t,a,e);void 0!==o&&u(200,"success",i(e,o),{})},t.fixture.delay)},abort:function(){s=!0,clearTimeout(o)}}});else{var o=t.ajax;t.ajax=function(e){if(n(e,e),e.fixture){var i,s=new t.Deferred,a=!1;return s.getResponseHeader=function(){},s.then(e.success,e.fail),s.abort=function(){clearTimeout(i),a=!0,s.reject(s)},i=setTimeout(function(){var t=function(){var t=r.apply(e,arguments),n=t[0];(n>=200&&300>n||304===n)&&a===!1?s.resolve(t[2][e.dataType]):s.reject(s,"error",t[1])},n=e.fixture(e,t,e.headers,e);void 0!==n&&s.resolve(n)},t.fixture.delay),s}return o(e)}}var s=[],a=function(t,e){for(var n=0;n<s.length;n++)if(c._similar(t,s[n],e))return n;return-1},u=function(t){var e=a(t);return e>-1?(t.fixture=s[e].fixture,c._getData(s[e].url,t.url)):void 0},l=function(t){var e=t.data.id;return void 0===e&&"number"==typeof t.data&&(e=t.data),void 0===e&&t.url.replace(/\/(\d+)(\/|$|\.)/g,function(t,n){e=n}),void 0===e&&(e=t.url.replace(/\/(\w+)(\/|$|\.)/g,function(t,n){"update"!=n&&(e=n)})),void 0===e&&(e=Math.round(1e3*Math.random())),e},c=t.fixture=function(e,n){if(void 0!==n){if("string"==typeof e){var r=e.match(/(GET|POST|PUT|DELETE) (.+)/i);e=r?{url:r[2],type:r[1]}:{url:e}}var i=a(e,!!n);if(i>-1&&s.splice(i,1),null==n)return;e.fixture=n,s.push(e)}else t.each(e,function(t,e){c(e,t)})},f=t.replacer;return t.extend(t.fixture,{_similar:function(e,n,r){return r?t.Object.same(e,n,{fixture:null}):t.Object.subset(e,n,t.fixture._compare)},_compare:{url:function(t,e){return!!c._getData(e,t)},fixture:null,type:"i"},_getData:function(e,n){var r=[],i=e.replace(".","\\.").replace("?","\\?"),o=new RegExp(i.replace(f,function(t,e){return r.push(e),"([^/]+)"})+"$").exec(n),s={};return o?(o.shift(),t.each(r,function(t){s[t]=o.shift()}),s):null},store:function(e,n,r,i){var o=[],s=0,a=function(t){for(var e=0;e<o.length;e++)if(t==o[e].id)return o[e]},u={};"string"==typeof e?e=[e+"s",e]:t.isArray(e)||(i=r,r=n,n=e),t.extend(u,{findAll:function(e){e=e||{};var n=o.slice(0);e.data=e.data||{},t.each((e.data.order||[]).slice(0).reverse(),function(t){var e=t.split(" ");n=n.sort(function(t,n){return"ASC"!==e[1].toUpperCase()?t[e[0]]<n[e[0]]?1:t[e[0]]==n[e[0]]?0:-1:t[e[0]]<n[e[0]]?-1:t[e[0]]==n[e[0]]?0:1})}),t.each((e.data.group||[]).slice(0).reverse(),function(t){var e=t.split(" ");n=n.sort(function(t,n){return t[e[0]]>n[e[0]]})});var r=parseInt(e.data.offset,10)||0,s=parseInt(e.data.limit,10)||o.length-r,a=0;for(var u in e.data)if(a=0,void 0!==e.data[u]&&(-1!=u.indexOf("Id")||-1!=u.indexOf("_id")))for(;a<n.length;)e.data[u]!=n[a][u]?n.splice(a,1):a++;if(i)for(a=0;a<n.length;)i(n[a],e)?a++:n.splice(a,1);return{count:n.length,limit:e.data.limit,offset:e.data.offset,data:n.slice(r,r+s)}},findOne:function(t,e){var n=a(l(t));e(n?n:void 0)},update:function(e,n){var r=l(e);t.extend(a(r),e.data),n({id:l(e)},{location:e.url||"/"+l(e)})},destroy:function(e){for(var n=l(e),r=0;r<o.length;r++)if(o[r].id==n){o.splice(r,1);break}return t.extend(a(n)||{},e.data),{}},create:function(e,n){var i=r(o.length,o);t.extend(i,e.data),i.id||(i.id=s++),o.push(i),n({id:i.id},{location:e.url+"/"+i.id})}});var c=function(){o=[];for(var i=0;n>i;i++){var a=r(i,o);a.id||(a.id=i),s=Math.max(a.id+1,s+1)||o.length,o.push(a)}t.isArray(e)&&(t.fixture["~"+e[0]]=o,t.fixture["-"+e[0]]=u.findAll,t.fixture["-"+e[1]]=u.findOne,t.fixture["-"+e[1]+"Update"]=u.update,t.fixture["-"+e[1]+"Destroy"]=u.destroy,t.fixture["-"+e[1]+"Create"]=u.create)};return c(),t.extend({getId:l,find:function(t){return a(l(t))},reset:c},u)},rand:function(t,e,n){if("number"==typeof t)return"number"==typeof e?t+Math.floor(Math.random()*(e-t)):Math.floor(Math.random()*t);var r=arguments.callee;if(void 0===e)return r(t,r(t.length+1));var i=[];t=t.slice(0),n||(n=e),n=e+Math.round(r(n-e));for(var o=0;n>o;o++)i.push(t.splice(r(t.length),1)[0]);return i},xhr:function(e){return t.extend({},{abort:t.noop,getAllResponseHeaders:function(){return""},getResponseHeader:function(){return""},open:t.noop,overrideMimeType:t.noop,readyState:4,responseText:"",responseXML:null,send:t.noop,setRequestHeader:t.noop,status:200,statusText:"OK"},e)},on:!0}),t.fixture.delay=200,t.fixture.rootUrl=e(""),t.fixture["-handleFunction"]=function(e){return"string"==typeof e.fixture&&t.fixture[e.fixture]&&(e.fixture=t.fixture[e.fixture]),"function"==typeof e.fixture?(setTimeout(function(){e.success&&e.success.apply(null,e.fixture(e,"success")),e.complete&&e.complete.apply(null,e.fixture(e,"complete"))},t.fixture.delay),!0):!1},t.fixture.overwrites=s,t.fixture.make=t.fixture.store,t.fixture});
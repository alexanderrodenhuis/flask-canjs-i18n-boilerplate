define(["can/util/library","can/observe"],function(t){var e=function(t,e){var n,r=t.length,i=0,o=[];for(i;r>i;i++){if(n=e[i],"string"!=typeof n)return null;if("**"==t[i])return e.join(".");if("*"==t[i])o.push(n);else{if(n!==t[i])return null;o.push(n)}}return o.join(".")},n=function(n,r,i,o,s){var a,u,l,c,f,d=r.split("."),p=(this._observe_delegates||[]).slice(0);n.attr=r,n.lastAttr=d[d.length-1];for(var h=0;a=p[h++];)if(!(n.batchNum&&a.batchNum===n.batchNum||a.undelegated)){c=void 0,f=!0;for(var m=0;m<a.attrs.length;m++)u=a.attrs[m],(l=e(u.parts,d))&&(c=l),u.value&&f?f=u.value===""+this.attr(u.attr):f&&a.attrs.length>1&&(f=void 0!==this.attr(u.attr));if(c&&f){var g=r.replace(c+".","");n.batchNum&&(a.batchNum=n.batchNum),"change"===a.event?(arguments[1]=g,n.curAttr=c,a.callback.apply(this.attr(c),t.makeArray(arguments))):a.event===i?a.callback.apply(this.attr(c),[n,o,s,g]):"set"===a.event&&"add"==i&&a.callback.apply(this.attr(c),[n,o,s,g])}}};return t.extend(t.Observe.prototype,{delegate:function(e,r,i){e=t.trim(e);for(var o,s=this._observe_delegates||(this._observe_delegates=[]),a=[],u=/([^\s=,]+)(?:=("[^",]*"|'[^',]*'|[^\s"',]*))?(,?)\s*/g;o=u.exec(e);)o[2]&&t.inArray(o[2].substr(0,1),['"',"'"])>=0&&(o[2]=o[2].substr(1,-1)),a.push({attr:o[1],parts:o[1].split("."),value:o[2],or:","===o[3]});return s.push({selector:e,attrs:a,callback:i,event:r}),1===s.length&&this.bind("change",n),this},undelegate:function(e,r,i){e=e&&t.trim(e);var o,s=0,a=this._observe_delegates||[];if(e)for(;s<a.length;)o=a[s],o.callback===i||!i&&o.selector===e?(o.undelegated=!0,a.splice(s,1)):s++;else a=[];return a.length||this.unbind("change",n),this}}),t.Observe.prototype.delegate.matches=e,t.Observe});
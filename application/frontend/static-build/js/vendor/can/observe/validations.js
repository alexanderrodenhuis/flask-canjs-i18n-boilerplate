define(["can/util/library","can/observe/attributes"],function(t){var e=function(e,n,r){if(r||(r=n,n={}),n=n||{},e="string"==typeof e?[e]:t.makeArray(e),!n.testIf||n.testIf.call(this)){var i=this;t.each(e,function(t){i.validations[t]||(i.validations[t]=[]),i.validations[t].push(function(e){var i=r.call(this,e,t);return void 0===i?void 0:n.message||i})})}},n=t.Observe.prototype.__set;return t.Observe.prototype.__set=function(e,r,i,o,s){var a=this,u=a.constructor.validations,l=function(n){var r=s&&s.call(a,n);return r!==!1&&t.trigger(a,"error",[e,n],!0),!1};if(n.call(a,e,r,i,o,l),u&&u[e]){var c=a.errors(e);c&&l(c)}return this},t.each([t.Observe,t.Model],function(n){if(void 0!==n){var r=n.setup;t.extend(n,{setup:function(t){r.apply(this,arguments),this.validations&&t.validations!==this.validations||(this.validations={})},validate:e,validationMessages:{format:"is invalid",inclusion:"is not a valid option (perhaps out of range)",lengthShort:"is too short",lengthLong:"is too long",presence:"can't be empty",range:"is out of range",numericality:"must be a number"},validateFormatOf:function(t,n,r){e.call(this,t,r,function(t){return"undefined"!=typeof t&&null!==t&&""!==t&&null==String(t).match(n)?this.constructor.validationMessages.format:void 0})},validateInclusionOf:function(t,n,r){e.call(this,t,r,function(t){if("undefined"!=typeof t){for(var e=0;e<n.length;e++)if(n[e]==t)return;return this.constructor.validationMessages.inclusion}})},validateLengthOf:function(t,n,r,i){e.call(this,t,i,function(t){return("undefined"==typeof t||null===t)&&n>0||"undefined"!=typeof t&&null!==t&&t.length<n?this.constructor.validationMessages.lengthShort+" (min="+n+")":"undefined"!=typeof t&&null!==t&&t.length>r?this.constructor.validationMessages.lengthLong+" (max="+r+")":void 0})},validatePresenceOf:function(t,n){e.call(this,t,n,function(t){return"undefined"==typeof t||""===t||null===t?this.constructor.validationMessages.presence:void 0})},validateRangeOf:function(t,n,r,i){e.call(this,t,i,function(t){return("undefined"==typeof t||null===t)&&n>0||"undefined"!=typeof t&&null!==t&&(n>t||t>r)?this.constructor.validationMessages.range+" ["+n+","+r+"]":void 0})},validatesNumericalityOf:function(t){e.call(this,t,function(t){var e=!isNaN(parseFloat(t))&&isFinite(t);return e?void 0:this.constructor.validationMessages.numericality})}})}}),t.extend(t.Observe.prototype,{errors:function(e,n){e&&(e=t.isArray(e)?e:[e]);var r={},i=this,o=function(e,o){t.each(o,function(t){var o=t.call(i,a?i.__convert?i.__convert(e,n):n:i.attr(e));o&&(r[e]||(r[e]=[]),r[e].push(o))})},s=this.constructor.validations,a=e&&1===e.length&&2===arguments.length;return t.each(e||s||{},function(t,e){"number"==typeof e&&(e=t,t=s[e]),o(e,t||[])}),t.isEmptyObject(r)?null:a?r[e[0]]:r}}),t.Observe});
define(["can/util/library","can/observe"],function(t){t.each([t.Observe,t.Model],function(e){if(void 0!==e){var n=function(t){return"object"==typeof t&&null!==t&&t};t.extend(e,{attributes:{},convert:{date:function(t){var e=typeof t;return"string"===e?(t=Date.parse(t),isNaN(t)?null:new Date(t)):"number"===e?new Date(t):t},number:function(t){return parseFloat(t)},"boolean":function(t){return"false"!==t&&"0"!==t&&t?!0:!1},"default":function(e,n,r,i){var o,s=t.getObject(i),a=window;return i.indexOf(".")>=0&&(o=i.substring(0,i.lastIndexOf(".")),a=t.getObject(o)),"function"==typeof s?s.call(a,e,n):e}},serialize:{"default":function(t){return n(t)&&t.serialize?t.serialize():t},date:function(t){return t&&t.getTime()}}});var r=e.setup;e.setup=function(e,n,i){var o=this;r.call(o,e,n,i),t.each(["attributes"],function(t){o[t]&&e[t]!==o[t]||(o[t]={})}),t.each(["convert","serialize"],function(n){e[n]!=o[n]&&(o[n]=t.extend({},e[n],o[n]))})}}});var e=t.Observe.prototype.setup;return t.Observe.prototype.setup=function(n){var r={};e.call(this,n),t.each(this.constructor.defaults,function(t,e){this.hasOwnProperty(e)||(r[e]=t)},this),this._init=1,this.attr(r),delete this._init},t.Observe.prototype.__convert=function(t,e){var n,r,i=this.constructor,o=this.attr(t);return i.attributes&&(n=i.attributes[t],r=i.convert[n]||i.convert["default"]),null!==e&&n?r.call(i,e,o,function(){},n):e},t.Observe.prototype.serialize=function(e,n){var r={},i=this.constructor,o={};return n=t.isArray(n)?n:[],n.push(this._cid),void 0!==e?o[e]=this[e]:o=this.__get(),t.each(o,function(e,o){var s,a;e instanceof t.Observe&&t.inArray(e._cid,n)>-1?r[o]=e.attr("id"):(s=i.attributes?i.attributes[o]:0,a=i.serialize?i.serialize[s]:0,r[o]=e&&"function"==typeof e.serialize?e.serialize(void 0,n):a?a(e,s):e)}),void 0!=e?r[e]:r},t.Observe});